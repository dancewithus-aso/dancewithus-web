<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DWU – Asociación Músico-Cultural</title>
  <style>
    :root{--gap:14px} body{font-family:system-ui,Arial,sans-serif;margin:0}
    header,footer{border-bottom:1px solid #eee} header{position:sticky;top:0;background:#fff;z-index:10}
    nav{max-width:1080px;margin:0 auto;padding:12px var(--gap);display:flex;gap:var(--gap);align-items:center;justify-content:space-between}
    nav a{padding:8px 10px;border-radius:8px;text-decoration:none;color:#111} nav a.active{outline:1px solid #ddd}
    main{max-width:1080px;margin:0 auto;padding:24px var(--gap) 64px} .grid{display:grid;gap:var(--gap)} .cards{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{border:1px solid #eee;border-radius:12px;padding:14px} .muted{color:#666;font-size:.95rem} .btn{display:inline-block;padding:10px 14px;border:1px solid #222;border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff} section{margin-top:28px} form{display:grid;gap:10px;max-width:520px} input,textarea,select{padding:10px;border:1px solid #ddd;border-radius:10px;width:100%}
    .hidden{display:none} .center{text-align:center}
  </style>

  <!-- Firebase SDK 10.12.2 -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAw9vHweGoLBmabfohcy8Q2m2Jifludsk",
      authDomain: "dance-with-us---web.firebaseapp.com",
      projectId: "dance-withus---web",
      storageBucket: "dance-with-us---web.appspot.com",
      messagingSenderId: "575597343365",
      appId: "1:575597343365:web:2e7e9e6b8c0c0c0c0c0c0"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    window.firebase = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword,
                        onAuthStateChanged, signOut, collection, addDoc, query, where,
                        getDocs, serverTimestamp, deleteDoc, doc, setDoc };
  </script>
</head>

<body>
<header>
  <nav>
    <a href="#inicio" id="logo" style="font-weight:bold;text-decoration:none;color:#111">DWU</a>
    <div style="display:flex;gap:8px">
      <a href="#inicio" id="tab-inicio" class="active">Inicio</a>
      <a href="#eventos" id="tab-eventos">Eventos</a>
      <a href="#servicios" id="tab-servicios">Servicios</a>
      <a href="#solicitud" id="tab-solicitud">Solicitud</a>
      <a href="#cuenta" id="tab-cuenta">Mi cuenta</a>
      <a href="#admin" id="tab-admin">Admin</a>
    </div>
  </nav>
</header>

<main>
  <!-- INICIO (ahora sí, la página principal) -->
  <section id="view-inicio">
    <h1>Bienvenidos a Dance With Us</h1>
    <p>Somos una asociación sin ánimo de lucro dedicada a promover la cultura de la música y el baile en todas sus facetas. Organizamos eventos, talleres y actividades para que músicos, bailarines y amantes de la cultura puedan conectar, aprender y disfrutar juntos.</p>
    <p>Nuestra misión es crear un espacio abierto y colaborativo donde el arte y la comunidad se encuentren. ¡Únete y forma parte de nuestra familia!</p>
    <div class="center" style="margin-top:28px">
      <a href="#solicitud" class="btn primary">Quiero unirme</a>
      <a href="#eventos" class="btn">Ver próximos eventos</a>
    </div>
  </section>

  <section id="view-eventos" class="hidden">
    <h1>Próximos eventos</h1>
    <div id="eventos-list" class="grid cards"></div>
  </section>

  <section id="view-servicios" class="hidden">
    <h1>Catálogo de servicios</h1>
    <div id="servicios-list" class="grid cards"></div>
  </section>

  <section id="view-solicitud" class="hidden">
    <h1>Solicitud de membresía</h1>
    <form id="form-solicitud">
      <input id="sNombre" placeholder="Nombre completo" required />
      <input id="sEmail" type="email" placeholder="Email" required />
      <input id="sTelefono" type="tel" placeholder="Teléfono" />
      <select id="sMembresia" required>
        <option value="">-- Tipo de membresía --</option>
        <option value="puntual">Puntual (aporta solo para un evento)</option>
        <option value="estandar">Estándar (cuota anual – entrada gratis a mayoría de eventos)</option>
        <option value="plata">Plata (mayor aporte + 5 % mín. descuento)</option>
        <option value="oro">Oro (alto aporte + 10 % mín. descuento)</option>
        <option value="platino">Platino (alto aporte + 15 % mín. descuento)</option>
        <option value="diamante">Diamante (solo Junta – 20 % mín. descuento)</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="sCederDiamante" /> Cedo ≥ 20 % descuento a otros miembros Diamante</label>
      <textarea id="sMensaje" placeholder="Cuéntanos un poco sobre ti"></textarea>
      <button type="submit" class="btn primary">Enviar solicitud</button>
    </form>
    <p id="sOk" class="hidden muted">✅ Solicitud enviada. Nos pondremos en contacto contigo pronto.</p>
  </section>

  <section id="view-cuenta" class="hidden">
    <h1>Mi cuenta</h1>
    <form id="form-login">
      <input id="email" type="email" placeholder="Email" required />
      <input id="telefono" type="tel" placeholder="Teléfono (opcional)" />
      <button class="btn primary" type="submit">Entrar / Continuar</button>
    </form>
    <div id="cuenta-detalle" class="hidden">
      <p><strong>Socio:</strong> <span id="cuenta-nombre"></span></p>
      <p><strong>Rango:</strong> <span id="cuenta-rango"></span></p>
      <p><strong>Cuota anual:</strong> <span id="cuota-info"></span></p>
      <h3>Mis entradas</h3>
      <div id="cuenta-entradas" class="grid cards"></div>
      <h3>Mis servicios</h3>
      <div id="mis-servicios-list" class="grid cards"></div>
      <button class="btn primary" onclick="mostrarFormServicio()">Añadir servicio</button>
    </div>
  </section>

  <section id="view-admin" class="hidden">
    <h1>Admin</h1>
    <form id="form-token" class="grid" style="max-width:360px">
      <input id="adminToken" placeholder="Token admin (DWU2025)" />
      <button type="submit" class="btn">Validar</button>
    </form>
    <div id="admin-panels" class="hidden">
      <h3>Crear evento</h3>
      <form id="form-evento">
        <input id="eTitulo" placeholder="Título" required />
        <input id="eFecha" type="datetime-local" required />
        <input id="eUbicacion" placeholder="Ubicación" />
        <textarea id="eDescripcion" placeholder="Descripción"></textarea>
        <input id="eAforo" type="number" placeholder="Aforo" />
        <button class="btn primary" type="submit">Guardar evento</button>
      </form>
      <h3>Solicitudes de membresía</h3>
      <div id="admin-solicitudes-list" class="grid cards"></div>
    </div>
  </section>
</main>

<footer class="center" style="padding:28px;border-top:1px solid #eee">
  <div class="muted">© <span id="year"></span> Asociación Músico-Cultural “Dance With Us”.</div>
</footer>

<!-- MODAL AÑADIR SERVICIO -->
<dialog id="modalServicio">
  <form method="dialog" id="form-servicio">
    <h3>Añadir servicio</h3>
    <input id="svTitulo" placeholder="Título del servicio" required />
    <textarea id="svDesc" placeholder="Descripción" required></textarea>
    <input id="svPrecio" type="number" placeholder="Precio (€)" required />
    <label>Descuento % para cada nivel (≥ mínimo)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
      <input id="svDescPuntual" type="number" min="0" max="99" placeholder="Puntual %" value="0" required />
      <input id="svDescEstandar" type="number" min="0" max="99" placeholder="Estándar %" value="0" required />
      <input id="svDescPlata" type="number" min="5" max="99" placeholder="Plata %" value="5" required />
      <input id="svDescOro" type="number" min="10" max="99" placeholder="Oro %" value="10" required />
      <input id="svDescPlatino" type="number" min="15" max="99" placeholder="Platino %" value="15" required />
      <input id="svDescDiamante" type="number" min="20" max="99" placeholder="Diamante %" value="20" required />
    </div>
    <input id="svFoto" type="url" placeholder="URL de foto (opcional)" />
    <input id="svCalendario" type="url" placeholder="URL calendario/disponibilidad (opcional)" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" type="submit">Guardar servicio</button>
      <button class="btn" onclick="cerrarFormServicio()">Cancelar</button>
    </div>
  </form>
</dialog>

<script>
// Router simple por hash
const views={inicio:qs('#view-inicio'),eventos:qs('#view-eventos'),servicios:qs('#view-servicios'),solicitud:qs('#view-solicitud'),cuenta:qs('#view-cuenta'),admin:qs('#view-admin')};
function qs(s){return document.querySelector(s)}
function show(tab){Object.values(views).forEach(v=>v.classList.add('hidden'));document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));(views[tab]||views.inicio).classList.remove('hidden');qs(`#tab-${tab}`)?.classList.add('active')}
addEventListener('hashchange',()=>show(location.hash.replace('#','')||'inicio'));show(location.hash.replace('#','')||'inicio');qs('#year').textContent=new Date().getFullYear();

// API helper (Google Apps Script)
async function api(ep, payload={}){
  const r = await fetch(`https://script.google.com/macros/s/AKfycbwltO0Kuat4XBvHaaGKKIJFeLioy2-AwNpjNKram7Ww8_1cEyPSiv1nPjL-hRAOLlIs/exec?endpoint=${encodeURIComponent(ep)}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const t = await r.text(); try{ return JSON.parse(t);}catch(e){ alert('API devolvió algo inesperado'); throw new Error(t); }
}

// Eventos
async function cargarEventos(){
  try{ const data=await api('listarEventos'); const el=qs('#eventos-list');
    el.innerHTML=(data.items||[]).map(ev=>`
      <div class="card">
        <h3>${ev.titulo||''}</h3>
        <div class="muted">${ev.fechaInicio||''} · ${ev.ubicacion||''}</div>
        <p>${ev.descripcion||''}</p>
        <button class="btn" onclick="comprar('${ev.id||''}')">Comprar</button>
      </div>`).join(''); }catch(e){ console.error(e); }
}
async function comprar(id){
  const email=prompt('Email para tu entrada:'); if(!email) return;
  try{ await api('crearPedido',{eventId:id,email}); alert('Pedido creado (pendiente de validar).'); }catch(e){ alert('No se pudo crear el pedido'); }
}

// Servicios
async function cargarServicios(){
  try{ const data=await api('listarServicios'); const el=qs('#servicios-list');
    el.innerHTML=(data.items||[]).map(s=>`
      <div class="card">
        <h3>${s.titulo||''}</h3>
        <p class="muted">Proveedor: ${s.proveedor||''}</p>
        <p>${s.descripcion||''}</p>
      </div>`).join(''); }catch(e){ console.error(e); }
}

// Solicitud de membresía
qs('#form-solicitud')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const { db, collection, addDoc, serverTimestamp } = window.firebase;
  const membresia=qs('#sMembresia').value;
  const cederDiamante=qs('#sCederDiamante').checked;
  if(membresia==='diamante' && !cederDiamante){ alert('Para Diamante debes ceder ≥ 20 % descuento a otros Diamante.'); return; }
  try{
    await addDoc(collection(db, 'membershipRequests'), {
      nombre:     qs('#sNombre').value.trim(),
      email:      qs('#sEmail').value.trim(),
      telefono:   qs('#sTelefono').value.trim(),
      membresia:  membresia,
      cederDiamante,
      mensaje:    qs('#sMensaje').value.trim(),
      createdAt:  serverTimestamp()
    });
    qs('#form-solicitud').reset();
    qs('#sOk').classList.remove('hidden');
  }catch(err){ alert('Error al enviar: '+err.message); }
});

// Cuenta
let currentUser=null;
qs('#form-login')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email=qs('#email').value.trim(), telefono=qs('#telefono').value.trim();
  try{
    const u=await api('login',{email,telefono});
    currentUser=u;
    qs('#cuenta-nombre').textContent=u.nombre||u.email;
    qs('#cuenta-rango').textContent=u.membresia||'Estándar';
    qs('#cuota-info').textContent=u.membresia==='diamante'?'Exenta':u.cuotaPagada?'57 € pagada':'Pendiente 57 €';
    qs('#form-login').classList.add('hidden'); qs('#cuenta-detalle').classList.remove('hidden');
    cargarMisServicios();
  }catch(e){ alert('No se pudo iniciar sesión'); }
});

// Mis servicios
async function cargarMisServicios(){
  if(!currentUser?.id) return;
  const { db, collection, query, where, getDocs } = window.firebase;
  const snap=await getDocs(query(collection(db,'servicios'),where('owner','==',currentUser.id)));
  const list=qs('#mis-servicios-list');
  list.innerHTML='';
  snap.forEach(doc=>{
    const s=doc.data();
    list.insertAdjacentHTML('beforeend',`
      <div class="card">
        <h3>${s.titulo}</h3>
        <p>${s.descripcion}</p>
        <p class="muted">Precio: ${s.precio} €</p>
        <p class="muted">Descuentos: P${s.descPuntual}% E${s.descEstandar}% Pl${s.descPlata}% O${s.descOro}% Plat${s.descPlatino}% D${s.descDiamante}%</p>
        <button class="btn" onclick="eliminarServicio('${doc.id}')">Eliminar</button>
      </div>`);
  });
}
window.mostrarFormServicio=()=>qs('#modalServicio').showModal();
window.cerrarFormServicio=()=>qs('#modalServicio').close();

qs('#form-servicio')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const { db, collection, addDoc, serverTimestamp } = window.firebase;
  if(!currentUser?.id){ alert('Debes iniciar sesión'); return; }
  const dp=Number(qs('#svDescPuntual').value), de=Number(qs('#svDescEstandar').value), dpl=Number(qs('#svDescPlata').value), dor=Number(qs('#svDescOro').value), dpt=Number(qs('#svDescPlatino').value), dd=Number(qs('#svDescDiamante').value);
  if(dpl<5||dor<10||dpt<15||dd<20){ alert('Descuentos deben cumplir mínimos: Plata 5 %, Oro 10 %, Platino 15 %, Diamante 20 %'); return; }
  try{
    await addDoc(collection(db,'servicios'),{
      owner:      currentUser.id,
      titulo:     qs('#svTitulo').value.trim(),
      descripcion:qs('#svDesc').value.trim(),
      precio:     Number(qs('#svPrecio').value),
      descPuntual:dp, descEstandar:de, descPlata:dpl, descOro:dor, descPlatino:dpt, descDiamante:dd,
      foto:       qs('#svFoto').value.trim(),
      calendario: qs('#svCalendario').value.trim(),
      createdAt:  serverTimestamp()
    });
    cerrarFormServicio(); qs('#form-servicio').reset(); cargarMisServicios();
  }catch(err){ alert('Error al guardar servicio: '+err.message); }
});
window.eliminarServicio=async(id)=>{
  if(!confirm('¿Eliminar este servicio?')) return;
  const { db, doc, deleteDoc } = window.firebase;
  await deleteDoc(doc(db,'servicios',id));
  cargarMisServicios();
};

// Admin
qs('#form-token')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const r=await api('validarToken',{token: qs('#adminToken').value.trim()});
    if(r.ok){ qs('#admin-panels').classList.remove('hidden'); cargarSolicitudes(); }
    else alert('Token incorrecto');
  }catch(e){ alert('Error de validación'); }
});
qs('#form-evento')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const p={ titulo:qs('#eTitulo').value.trim(), fechaInicio:qs('#eFecha').value, ubicacion:qs('#eUbicacion').value.trim(), descripcion:qs('#eDescripcion').value.trim(), aforo:Number(qs('#eAforo').value||0) };
  try{ await api('crearEvento',p); alert('Evento guardado'); cargarEventos(); }catch(e){ alert('No se pudo guardar'); }
});

// ----------- ADMIN: VER Y APROBAR SOLICITUDES -----------
async function cargarSolicitudes(){
  const { db, collection, query, getDocs, deleteDoc, addDoc, serverTimestamp, doc } = window.firebase;
  const qSnap = await getDocs(collection(db,'membershipRequests'));
  const list = qs('#admin-solicitudes-list');
  list.innerHTML='';
  qSnap.forEach(docSnap=>{
    const d=docSnap.data();
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <strong>${d.nombre}</strong> (${d.membresia})<br/>
      <span class="muted">${d.email} · ${d.telefono||''}</span><br/>
      <em>${d.mensaje||''}</em><br/>
      <button class="btn primary" onclick="aprobar('${docSnap.id}','${d.membresia}')">Aprobar</button>`;
    list.appendChild(card);
  });
}
async function aprobar(id,membresia){
  const { db, collection, getDoc, doc, deleteDoc, addDoc, serverTimestamp } = window.firebase;
  const snap = await getDoc(doc(db,'membershipRequests',id));
  if(!snap.exists()) return alert('Solicitud no encontrada');
  const data=snap.data();
  // Crear usuario con su membresía
  await addDoc(collection(db,'users'),{
    nombre:     data.nombre,
    email:      data.email,
    telefono:   data.telefono||'',
    membresia:  membresia,
    cuotaPagada:false,
    descuento:  {puntual:0, estandar:0, plata:5, oro:10, platino:15, diamante:20}[membresia],
    rol:        'socio',
    createdAt:  serverTimestamp()
  });
  // Borrar solicitud
  await deleteDoc(doc(db,'membershipRequests',id));
  cargarSolicitudes();
  alert('Socio aprobado y añadido con membresía '+membresia.toUpperCase()+'. Recuerda abonar la cuota de 57 €.');
}

qs('#admin-panels').addEventListener('DOMNodeInserted',()=>cargarSolicitudes(),{once:true});

cargarEventos(); cargarServicios();
</script>
</body>
</html>
